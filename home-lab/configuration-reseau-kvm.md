---
description: >-
  Les serveurs tournant avec KVM n√©cessite une configuration particuli√®re
  d√©crite ici
---

# Configuration network host en mode routed sur KVM

{% hint style="info" %}
RAPPEL: Les serveurs sont sous Debian 10 avec KVM et qemu d'installer afin de pouvoir g√©rer des VMs et me familiariser avec l'outil KVM.
{% endhint %}

Sur ces serveurs beaucoup de choses sont √† faire et le moindre petit fail entraine une action manuelle directement sur le serveur via la console. Donc on y va doucement üëÄ 

### \#1 CHALLENGE: NAT passthrough

Le premier challenge √©tait de faire un **NAT passthrough** de mani√®re a partager la table ARP vers le firewall et partager le m√™me r√©seau physique.

Pour ce faire nous devons cr√©e un network bridge sur la m√™me plage r√©seau que le r√©seau physique qui est en `172.16.0.0/16`. Nous allons aussi attribu√© l'ip du serveur `server-01` au bridge ! Cela est tr√®s important que l'ip soit sur le bridge et non sur l'interface physique, j'explique cela juste apr√®s.

```markup
<!-- network.yml -->
<network>
  <name>routed</name>
  <forward dev='enp4s0f0' mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
    <!-- Interface of phyisical link -->
    <interface dev='enp4s0f0'/> 
  </forward>
  <bridge name='virbr1' stp='on' delay='0'/>
  <!-- IP of host | No DHCP configured, manual attribution -->
  <ip address='172.16.1.1' netmask='255.255.0.0'>
  </ip>
</network>
```

Une fois le network d√©fini et d√©marr√© avec `virsh net-define network.yml`, il faut ajouter l'interface physique au bridge avec la commande :

```bash
brctl addif virbr1 enp4s0f0
```

Une fois l'interface bridg√©, il faut retirer la configuration de l'interface physique `enp4s0f0` pour √©viter les overlap des adresses MAC dans la table ARP du router.

Un petit √©dit de `/etc/network/interfaces` pour passer l'interface en manual

```text
allow-hotplug enp4s0f0
iface enp4s0f0 inet manual
```

Apr√®s cela il faut bien penser surtout si vous √™tes en DHCP √† retirer toutes les leases DHCP de l'interface dans `/var/lib/dhcp/enp4s0f0/leases` sinon au red√©marrage du service networking vous aller r√©cup√©rer une IP d√©j√† lease.

Vous pouvez maintenant retirer l'ip de l'interface avec `ip addr delete x.x.x.x/x dev enp4s0f0`, red√©marr√© ensuite le service `systemctl restart networking`. Vous allez √† pr√©sent pouvoir v√©rifier la table ARP de votre router et voir l'adresse MAC de votre bridge √† la place de l'adresse mac de l'interface physique. üéâ 

Il se peut que la route par default ne soit plus active. vous pouvez v√©rifier avec la commande `ip route`, son retour devrait √™tre:

```text
default via 172.16.0.1 dev virbr1
172.16.0.0/16 dev virbr1 proto kernel scope link src 172.16.1.1
```

Si le default n'est pas pr√©sent, vous n'aurez pas internet. Dans ce cas ajouter la route par default.

{% hint style="danger" %}
ATTENTION: cela doit passer par l'interface bridge !
{% endhint %}

```bash
ip r add default via 172.16.0.1 dev virbr1
```

Cela doit √™tre l'IP de votre router physique et non pas l'ip de votre serveur. Nous somme derri√®re un NAT, mais nous n'avons pas besoin de faire de routage √† travers notre serveur, comme la table ARP est directement rout√© vers le router, le serveur ne sert donc plus de Gateway. C'est le but de cette configuration.

Pensez √† activer le forward ipv4 / ipv6 ainsi que la propagation ARP.

```text
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1
```

Une derni√®re petite chose doit √™tre fait, v√©rifier que vos r√®gles **iptables** soit correctement √©crites. Dans notre cas nous avons une policy en `default: ACCEPT` car nous disposons d'un firewall physique, et que le r√©seau interne est priv√©e √† uniquement moi. Si vous n'avez pas de firewall physique ou que vous partager le r√©seaux avec des clients ou des personnes ext√©rieur, partez du principe de tout `DROP`

```bash
# Generated by xtables-save v1.8.2 on Mon Feb 15 17:38:32 2021
*filter
:INPUT ACCEPT [1295078:91029645]
:FORWARD ACCEPT [182584:154585157]
:OUTPUT ACCEPT [134678:24102871]
-A INPUT -i virbr1 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -i virbr1 -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -i virbr1 -p udp -m udp --dport 67 -j ACCEPT
-A INPUT -i virbr1 -p tcp -m tcp --dport 67 -j ACCEPT
-A FORWARD -d 172.16.0.0/16 -i enp4s0f0 -o virbr1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 172.16.0.0/16 -i virbr1 -o enp4s0f0 -j ACCEPT
-A FORWARD -i virbr1 -o virbr1 -j ACCEPT
-A FORWARD -o virbr1 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -i virbr1 -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -d 172.10.16.0/20 -i enp4s0f0 -o virbr1 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -s 172.10.16.0/20 -i virbr1 -o enp4s0f0 -j ACCEPT
-A FORWARD -d 172.10.16.0/20 -i virbr1 -o virbr1 -j ACCEPT
-A FORWARD -i enp4s0f0 -o virbr1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i enp4s0f0 -o virbr1 -j ACCEPT
-A FORWARD -i virbr1 -o enp4s0f0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i virbr1 -o enp4s0f0 -j ACCEPT
-A OUTPUT -o virbr1 -p udp -m udp --dport 68 -j ACCEPT
COMMIT
# Completed on Mon Feb 15 17:38:32 2021
# Generated by xtables-save v1.8.2 on Mon Feb 15 17:38:32 2021
*nat
:PREROUTING ACCEPT [237862:47243821]
:INPUT ACCEPT [10415:1901082]
:POSTROUTING ACCEPT [4:226]
:OUTPUT ACCEPT [5262:469854]
-A POSTROUTING -s 172.16.0.0/16 -d 224.0.0.0/24 -o enp4s0f0 -j RETURN
-A POSTROUTING -s 172.16.0.0/16 -d 255.255.255.255/32 -o enp4s0f0 -j RETURN
-A POSTROUTING -s 172.16.0.0/16 ! -d 172.16.0.0/16 -o enp4s0f0 -p tcp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 172.16.0.0/16 ! -d 172.16.0.0/16 -o enp4s0f0 -p udp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 172.16.0.0/16 ! -d 172.16.0.0/16 -o enp4s0f0 -j MASQUERADE
-A POSTROUTING -s 172.10.16.0/20 -d 224.0.0.0/24 -o enp4s0f0 -j RETURN
-A POSTROUTING -s 172.10.16.0/20 -d 255.255.255.255/32 -o enp4s0f0 -j RETURN
-A POSTROUTING -s 172.10.16.0/20 ! -d 172.10.16.0/20 -o enp4s0f0 -p tcp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 172.10.16.0/20 ! -d 172.10.16.0/20 -o enp4s0f0 -p udp -j MASQUERADE --to-ports 1024-65535
-A POSTROUTING -s 172.10.16.0/20 ! -d 172.10.16.0/20 -o enp4s0f0 -j MASQUERADE
-A POSTROUTING -o enp4s0f0 -j MASQUERADE
-A POSTROUTING -o virbr1 -j MASQUERADE
COMMIT
# Completed on Mon Feb 15 17:38:32 2021
# Generated by xtables-save v1.8.2 on Mon Feb 15 17:38:32 2021
*mangle
:PREROUTING ACCEPT [2545510:788932935]
:INPUT ACCEPT [1298930:91442486]
:FORWARD ACCEPT [1127409:682314363]
:OUTPUT ACCEPT [137728:24628861]
:POSTROUTING ACCEPT [1263301:706820609]
COMMIT
# Completed on Mon Feb 15 17:38:32 2021
```

> Configuration iptables du serveur host.

Une fois cela configurer, changez la configuration de vos VMs avec virsh console et √©diter les fichiers `/etc/network/interfaces` de vos VMs pour configurer leurs IP a la main.

{% hint style="warning" %}
**ATTENTION**: la Gateway de vos VMs doit √™tre le router physique `172.16.0.1/16` dans notre configuration actuelle.
{% endhint %}

